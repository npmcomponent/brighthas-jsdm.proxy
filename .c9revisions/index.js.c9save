{"ts":1373833640151,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var uuid = require(\"uuid\");\nvar Emit  = require(\"emitter\");\n\nfunction Proxy(socket,domainName){\n    this._domainName = domainName;\n    this._socket = socket;\n    var emitter =  this._emitter = new Emit;\n\n    // for query\n    var emitter2 = this._emitter2 = new Emit;\n\n    // for exec\n    var emitter3 = this._emitter3 = new Emit;\n\n    // for call\n    var emitter4 =  this._emitter4 = new Emit;\n\n    this._socket.on(this._domainName+\"-query-result\",function(rs){\n        var qid = rs.qid;\n        var data = rs.data;\n        emitter2.emit.call(emitter2,qid,data);\n    })\n\n\n    this._socket.on(this._domainName+\"-exec-result\",function(rs){\n        emitter3.emit.apply(emitter3,rs);\n    })\n\n\n    this._socket.on(this._domainName+\"-call-result\",function(rs){\n        emitter4.emit.apply(emitter4,rs);\n    })\n\n    this._socket.on(this._domainName+\"-emit\",function(event){\n        emitter.emit.apply(emitter,arguments);\n    })\n\n}\n\nProxy.prototype = {\n\n    query:function(queryName,args,callback){\n\n        var qid = uuid();\n        this._emitter2.once(qid,callback);\n        this._socket.emit(this._domainName+\"-query\",{qid:qid,queryName:queryName,args:args});\n\n    },\n\n    on:function(eventname,callback){\n        this._emitter.on(eventname,callback);\n        this._socket.emit(this._domainName+\"-on\",eventname);\n    },\n\n    once:function(eventname,callback){\n        this._emitter.once(eventname,callback);\n        this._socket.emit(this._domainName+\"-once\",eventname);\n    },\n\n    exec:function(commandName,args,callback){\n        var commandId = uuid();\n        this._emitter3.once(commandId,callback);\n        this._socket.emit(this._domainName+\"-exec\",{commandId:commandId,commandName:commandName,args:args});\n    },\n\n    call:function(methodName,id,args,callback){\n        var callId = uuid();\n        this._emitter4.once(callId,callback);\n        this._socket.emit(this._domainName+\"-call\",{callId:callId,methodName:methodName,id:id,args:args});\n    }\n\n}\n\nmodule.exports  =  Proxy;\n\n"]],"start1":0,"start2":0,"length1":0,"length2":1985}]],"length":1985}
{"contributors":[],"silentsave":false,"ts":1373833618735,"patch":[[{"diffs":[[0,"var "],[-1,"uuid"],[1,"jq"],[0," = requi"]],"start1":0,"start2":0,"length1":16,"length2":14},{"diffs":[[0,"re(\""],[-1,"uuid"],[1,"jquery"],[0,"\");"],[1,"\r"],[0,"\nvar"]],"start1":14,"start2":14,"length1":15,"length2":18},{"diffs":[[0,"itter\");"],[-1,"\n"],[1,"\r"],[0,"\nfunctio"]],"start1":52,"start2":52,"length1":17,"length2":17},{"diffs":[[0,"oxy("],[-1,"socket,domainName"],[1,"url"],[0,"){"],[1,"\r"],[0,"\n    "],[-1,"this._domainName = domainName;\n    this._socket = socket;\n    var emitter ="],[1,"    \r\n      "],[0,"  th"]],"start1":73,"start2":73,"length1":107,"length2":31},{"diffs":[[0,"mit;"],[-1,"\n"],[1,"\r"],[0,"\n    "],[-1,"// for query\n    var emitter2 = this._emitter2 = new Emit;\n\n    // for exec\n    var emitter3"],[1,"    this._url = url;\r\n        this._events = {};\r\n        var self "],[0," ="],[1," "],[0," this"],[-1,"._emitter3 = new Emit;\n\n    // for call\n    var emitter4 =  this._emitter4 = new Emit;\n\n    this._socket.on(this._domainName+\"-query-result\","],[1,";\r\n        var timeout = 0;\r\n        \r\n        function loop(){\r\n            clearTimeout(timeout);\r\n            timeout = setTimeout("],[0,"func"]],"start1":123,"start2":123,"length1":254,"length2":223},{"diffs":[[0,"ion("],[-1,"rs){\n"],[1,"){\r\n "],[0,"        "],[-1,"var qid = rs.qid;\n        var data = rs.data;\n        emitter2.emit.call(emitter2,qid,data"],[1,"       var esk = Object.keys(self._events);\r\n                \r\n                if(esk.length === 0"],[0,");"],[1,"\r"],[0,"\n    "],[-1,"})\n\n\n    this._socket.on(this._domainName+\"-exec-result\""],[1,"            else{ \r\n\r\n                    jq.post(self._url,{method:\"on\",events:JSON.stringify(self._events)}"],[0,",fun"]],"start1":347,"start2":347,"length1":174,"length2":236},{"diffs":[[0,")},function(rs){"],[1,"\r"],[0,"\n        emitter"]],"start1":577,"start2":577,"length1":32,"length2":33},{"diffs":[[0,"    "],[-1,"emitter3.emit.apply(emitter3,rs);"],[1,"                for(var en in rs){\r"],[0,"\n    "],[-1,"})\n\n\n    this._socket.on(this._domainName+\"-call-result\",function(rs){\n        "],[1,"                        if(self._events[en]){\r\n                                self._events[en] = rs[en].time;\r\n                            }\r\n                            self._"],[0,"emitter"],[-1,"4"],[0,".emi"]],"start1":599,"start2":599,"length1":133,"length2":232},{"diffs":[[0,"ply("],[1,"self._"],[0,"emitter"],[-1,"4"],[0,",rs"],[1,"[en].data"],[0,");"],[1,"\r"],[0,"\n    "],[-1,"})\n\n    this._socket.on(this._domainName+\"-emit\",function(event){\n        emitter.emit.apply(emitter,arguments"],[1,"                    }\r\n                        loop();\r\n                        \r\n                    });\r\n                }    \r\n            },3000);\r\n        }\r\n        \r\n        this._loop = loop;\r\n        \r\n        loop("],[0,");"],[1,"\r"],[0,"\n    }"],[-1,")\n\n}\n\n"],[1,"\r\n\r\n    "],[0,"Prox"]],"start1":835,"start2":835,"length1":150,"length2":282},{"diffs":[[0," = {"],[-1,"\n\n    query:function(queryName,args"],[1,"\r\n    \r\n        on:function(eventname"],[0,",cal"]],"start1":1128,"start2":1128,"length1":43,"length2":45},{"diffs":[[0,"ck){"],[-1,"\n\n"],[1,"\r\n    "],[0,"        "],[-1,"var qid = uuid"],[1,"if(eventname in this._events){\r\n            }else{\r\n                this._events[eventname] = Date.now"],[0,"();"],[1,"\r"],[0,"\n"],[1,"            }\r\n    "],[0,"    "]],"start1":1176,"start2":1176,"length1":36,"length2":148},{"diffs":[[0,"tter"],[-1,"2"],[0,".on"],[-1,"ce(qid"],[1,"(eventname"],[0,",cal"]],"start1":1337,"start2":1337,"length1":18,"length2":21},{"diffs":[[0,"tname,callback);"],[1,"\r"],[0,"\n        this._s"]],"start1":1349,"start2":1349,"length1":32,"length2":33},{"diffs":[[0,"    "],[1,"    "],[0,"this._"],[-1,"socket.emit(this._domainName+\"-query\",{qid:qid,queryName:queryName,args:args});\n\n"],[1,"loop();\r\n   "],[0,"    "],[1," "],[0,"},"],[-1,"\n\n"],[1,"\r\n        \r\n   "],[0,"    "],[1," "],[0,"on"],[1,"ce"],[0,":fun"]],"start1":1371,"start2":1371,"length1":109,"length2":61},{"diffs":[[0,"ck){"],[-1,"\n"],[1,"\r\n   "],[0,"        "],[-1,"this._emitter.on(eventname,callback);\n        this._socket.emit(this._domainName+\"-on\",eventname"],[1," if(eventname in this._events){\r\n            }else{\r\n                this._events[eventname] = Date.now("],[0,");"],[1,"\r"],[0,"\n    "],[-1,"},\n\n    once:function(eventname,callback){\n"],[1,"        }\r\n    "],[0,"    "]],"start1":1454,"start2":1454,"length1":163,"length2":148},{"diffs":[[0,"tname,callback);"],[-1,"\n"],[1," \r\n    "],[0,"        this._so"]],"start1":1629,"start2":1629,"length1":33,"length2":39},{"diffs":[[0,"is._"],[-1,"socket.emit(this._domainName+\"-once\",eventname"],[1,"loop("],[0,");"],[1,"\r"],[0,"\n    "],[-1,"},\n\n"],[1,"    },\r\n        \r\n "],[0,"    "],[1,"   "],[0,"exec"]],"start1":1662,"start2":1662,"length1":69,"length2":47},{"diffs":[[0,",args,callback){"],[1,"\r"],[0,"\n        var com"]],"start1":1730,"start2":1730,"length1":32,"length2":33},{"diffs":[[0,"    "],[-1,"var commandId = uuid("],[1,"  jq.post(this._url,{method:\"exec\",commandName:commandName,args:JSON.stringify(args)},function(avgs){\r\n            callback.apply(null,avgs"],[0,");"],[1,"\r"],[0,"\n   "]],"start1":1752,"start2":1752,"length1":31,"length2":150},{"diffs":[[0,"    "],[-1,"this._emitter3.once(commandId,callback);\n        this._socket.emit(this._domainName+\"-exec\",{commandId:commandId,commandName:commandName,args:args});\n    },\n\n    call:function(methodName,id,"],[1,"  })\r\n        },\r\n        \r\n        call:function(methodName,id,args,callback){\r\n          args = args?args:[];\r\n          jq.post(this._url,{method:\"call\",methodName:methodName,id:id,args:JSON.stringify(args)},function(avgs){\r\n            callback.apply(null,avgs);\r\n          }) \r\n        },\r\n        \r\n        query:function(name,args,callback){\r\n          jq.post(this._url,{method:\"query\",queryName:name,args:JSON.stringify("],[0,"args"],[1,")}"],[0,",cal"]],"start1":1903,"start2":1903,"length1":202,"length2":443},{"diffs":[[0,"ack)"],[-1,"{\n        var callId = uuid();\n        this._emitter4.once(callId,callback);\n        this._socket.emit(this._domainName+\"-call\",{callId:callId,methodName:methodName,id:id,args:args});\n    }\n\n}\n"],[1,";\r\n        },\r\n        \r\n        empty:function(){\r\n            var self = this;\r\n            this._events = {};\r\n            var ks = Object.keys(this._events);\r\n            ks.forEach(function(k){\r\n                self._emitter.off(k);\r\n            })\r\n        },\r\n        \r\n        off:function(){\r\n            this._emitter.off.apply(this._emitter,arguments);\r\n        }\r\n        \r\n}\r\n    \r"],[0,"\nmod"]],"start1":2348,"start2":2348,"length1":201,"length2":402},{"diffs":[[0,"  Proxy;"],[-1,"\n"],[1,"\r"],[0,"\n"]],"start1":2764,"start2":2764,"length1":10,"length2":10}]],"length":2774,"saved":false}
